# 1. 虚拟内存地址布局
```sql
+----------------------+
| 用户空间 (User Space)|
+----------------------+
| 内核空间 (Kernel)    |
+----------------------+
| 硬件 (Hardware)      |
+----------------------+

```
## 1.1 用户空间
运行普通用户程序（如 shell、应用程序、浏览器等）的空间。用户程序不能直接访问硬件，也不能访问内核空间
### 1.1.1 主要特点：
- 虚拟地址空间独立（每个进程拥有自己的地址空间）
- 运行在非特权模式（CPU ring3）
- 只能通过系统调用与内核交互

## 1.2 内核空间
操作系统核心的运行环境，具有最高权限，可直接访问硬件
### 1.2.1 主要特点：
- 运行在特权模式（CPU ring0）
- 所有进程共享同一个内核地址空间
- 提供系统服务：进程调度、内存管理、文件系统、网络、驱动等
### 1.2.2 包含内容：
- 内核代码
- 内核模块（如驱动程序）
- 页表、内核栈、slab 缓存
## 1.3 硬件
物理设备本身，包括 CPU、内存、磁盘、网卡、显卡、中断控制器、I/O 设备等
### 1.3.1 特点：
- 通过寄存器、DMA、端口等进行控制
- 不允许用户程序直接访问（除非裸机开发）
### 1.3.2 访问方式：
- 内核通过设备驱动访问硬件
- 用户空间必须经过内核驱动

# 2. 用户空间内存管理层次结构简图
```sql
+-------------------------------------------------------+
| 应用程序1 | 应用程序2 | 应用程序3 | 应用程序4 | 应用程序5 |
+-------------------------------------------------------+
|       malloc/free        |         new/delete         |
+-------------------------------------------------------+
|      ptmalloc    |     jemalloc     |    tcmalloc     |
+-------------------------------------------------------+
|       glibc      |      Freebsd     |     google      |
+-------------------------------------------------------+
```
## 2.1 第一层：应用程序
最终使用内存的主体，如各种用户程序：数据库、浏览器、Nginx、Python解释器等。这些程序会使用标准 C/C++ 的接口来申请/释放内存，例如：
- malloc() / free()
- new / delete

## 2.2 第二层：标准内存接口
- malloc/free：C 语言的标准内存分配/释放接口
- new/delete：C++ 的动态内存接口，本质上也会调用 malloc 等

## 2.3 第三层：具体的分配器实现
- <mark>ptmalloc</mark>	:默认的 glibc malloc 实现，适用于多数 Linux 程序
- <mark>jemalloc</mark>	:Facebook 等广泛使用，性能更好，碎片更少
- <mark>tcmalloc</mark>	:Google 出品，适用于高性能服务（如 Bigtable）
### 3. 内核空间内存管理层次结构
```sql
sys_brk/sys_mmap/sys_munmap
+-------------------------------------------------------+
| 虚拟内存管理 | 页回收 | .......................        |
+-------------------------------------------------------+
| 页表管理  |  错误异常处理  |  内存碎片整理  |  内存耗尽  |
+------------------------------------------------------------------------------+
|     引导内存分配器  | 块分配器 | 不连续页分配器 | 连续页分配器 | 每处理器内存分配器|
+                    ----------------------------------------------------------+
|                   |                         页分配器                         |
+------------------------------------------------------------------------------+
```
