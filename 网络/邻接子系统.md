邻接子系统是 Linux 内核中用于记录并管理设备之间邻接关系（上层设备与下层设备之间绑定关系）的一套结构和机制
### 1.NDISC协议
**NDISC（Neighbor Discovery Protocol, 邻居发现协议）** 是 IPv6 中用于节点之间 **自动发现邻居（如路由器或主机）** 的一套核心协议，取代了 IPv4 中的 ARP、ICMP 路由器发现、重定向等多个机制。简而言之，NDISC 是 IPv6 网络中负责“邻居发现、路由器发现、地址解析和重定向”的协议，基于 ICMPv6
### 2.ARP协议
**ARP（Address Resolution Protocol，地址解析协议）** 是 IPv4 网络中的一项基础协议，用于通过目标主机的 IP 地址解析出其 MAC 地址，从而在以太网等链路层网络中完成实际通信。简而言之，ARP 协议用于将 IP 地址映射为对应的 MAC 地址，是 IPv4 局域网通信的关键机制

### 3.广播地址
有时不需要邻接子系统也能知道目标地址。比如发送广播：
- Ethernet Header 的 DST 填的是广播地址：ff:ff:ff:ff:ff:ff
- ARP 请求中的目标硬件地址（Target MAC）字段填 0（全 0）：00:00:00:00:00:00
### 4.struct neighbour
Linux 内核中用于表示“邻居节点”的核心数据结构

> include/net/neighbour.h
```c
//每一个 IP ↔ MAC 映射会对应一个 neighbour
struct neighbour {
	struct hlist_node	hash;
	struct hlist_node	dev_list;
	struct neigh_table	*tbl; // 与邻居相关的邻居表,arp_tbl 就是 IPv4 ARP 缓存表，nd_tbl 是 IPv6 邻居发现表
	struct neigh_parms	*parms;
	unsigned long		confirmed; // 最近一次确认可达的时间戳
	unsigned long		updated;
	rwlock_t		lock;
	refcount_t		refcnt; // 引用计数（释放/销毁时用）
	unsigned int		arp_queue_len_bytes;
	struct sk_buff_head	arp_queue; // 挂起的未解析的 skb 队列
	struct timer_list	timer; // 定时器：超时后可重试或回收
	unsigned long		used;
	atomic_t		probes;
	u8			nud_state;
	u8			type;
	u8			dead;
	u8			protocol;
	u32			flags;
	seqlock_t		ha_lock; // 用于访问硬件地址 ha[] 时的锁
	unsigned char		ha[ALIGN(MAX_ADDR_LEN, sizeof(unsigned long))] __aligned(8); // 邻居硬件地址（如 MAC 地址）
	struct hh_cache		hh; // 	硬件头缓存，加速发送路径用（如硬件封装头）
	int			(*output)(struct neighbour *, struct sk_buff *); // 发包处理函数
	const struct neigh_ops	*ops; // 该邻居的操作函数集合
	struct list_head	gc_list;
	struct list_head	managed_list;
	struct rcu_head		rcu;
	struct net_device	*dev;
	netdevice_tracker	dev_tracker;
	u8			primary_key[]; //存储邻居IP 地址（key）作为哈希键
} __randomize_layout;
```
### 5. struct neigh_table

> include/net/neighbour.h
```c
struct neigh_table {
	int			family; // 每个协议都会创建自己的neigh_table实例 AF_INET（IPv4）、AF_INET6（IPv6）
	unsigned int		entry_size; //struct neighbour 的大小（通常用于 slab 分配）
	unsigned int		key_len; // 关键字（primary key）长度，IPv4 是 4，IPv6 是 16
	__be16			protocol; // 协议类型，如 ETH_P_IP（IPv4）或 ETH_P_IPV6
	__u32			(*hash)(const void *pkey,
					const struct net_device *dev,
					__u32 *hash_rnd); // 哈希函数：将 key（如 IP）映射为哈希值，用于散列表
	bool			(*key_eq)(const struct neighbour *, const void *pkey);
	int			(*constructor)(struct neighbour *); //创建一个新的邻居项时的构造函数
	int			(*pconstructor)(struct pneigh_entry *); //预邻居（pneigh_entry）构造器，主要用于代理 ARP/ND
	void			(*pdestructor)(struct pneigh_entry *); // pneigh_entry 的析构函数
	void			(*proxy_redo)(struct sk_buff *skb);
	int			(*is_multicast)(const void *pkey);
	bool			(*allow_add)(const struct net_device *dev,
					     struct netlink_ext_ack *extack);
	char			*id; //表的名字，如 "arp_cache"、"ndisc_cache"
	struct neigh_parms	parms;
	struct list_head	parms_list;
	int			gc_interval;
	int			gc_thresh1;
	int			gc_thresh2;
	int			gc_thresh3;
	unsigned long		last_flush;
	struct delayed_work	gc_work;
	struct delayed_work	managed_work;
	struct timer_list 	proxy_timer;
	struct sk_buff_head	proxy_queue;
	atomic_t		entries;
	atomic_t		gc_entries;
	struct list_head	gc_list;
	struct list_head	managed_list;
	rwlock_t		lock;
	unsigned long		last_rand;
	struct neigh_statistics	__percpu *stats;  //每 CPU 的邻居统计信息
	struct neigh_hash_table __rcu *nht; // 实际的邻居哈希桶（struct neighbour * 链接其中）
	struct pneigh_entry	**phash_buckets;
};
```
