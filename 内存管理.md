# 1. 虚拟内存地址布局
```sql
+----------------------+
| 用户空间 (User Space)|
+----------------------+
| 内核空间 (Kernel)    |
+----------------------+
| 硬件 (Hardware)      |
+----------------------+

```
## 1.1 用户空间
运行普通用户程序（如 shell、应用程序、浏览器等）的空间。用户程序不能直接访问硬件，也不能访问内核空间
### 1.1.1 主要特点：
- 虚拟地址空间独立（每个进程拥有自己的地址空间）
- 运行在非特权模式（CPU ring3）
- 只能通过系统调用与内核交互

## 1.2 内核空间
操作系统核心的运行环境，具有最高权限，可直接访问硬件
### 1.2.1 主要特点：
- 运行在特权模式（CPU ring0）
- 所有进程共享同一个内核地址空间
- 提供系统服务：进程调度、内存管理、文件系统、网络、驱动等
### 1.2.2 包含内容：
- 内核代码
- 内核模块（如驱动程序）
- 页表、内核栈、slab 缓存
## 1.3 硬件
物理设备本身，包括 CPU、内存、磁盘、网卡、显卡、中断控制器、I/O 设备等
### 1.3.1 特点：
- 通过寄存器、DMA、端口等进行控制
- 不允许用户程序直接访问（除非裸机开发）
### 1.3.2 访问方式：
- 内核通过设备驱动访问硬件
- 用户空间必须经过内核驱动

# 2. 用户空间内存管理层次结构简图
```sql
+-------------------------------------------------------+
| 应用程序1 | 应用程序2 | 应用程序3 | 应用程序4 | 应用程序5 |
+-------------------------------------------------------+
|       malloc/free        |         new/delete         |
+-------------------------------------------------------+
|      ptmalloc    |     jemalloc     |    tcmalloc     |
+-------------------------------------------------------+
|       glibc      |      Freebsd     |     google      |
+-------------------------------------------------------+
```
## 2.1 第一层：应用程序
最终使用内存的主体，如各种用户程序：数据库、浏览器、Nginx、Python解释器等。这些程序会使用标准 C/C++ 的接口来申请/释放内存，例如：
- malloc() / free()
- new / delete

## 2.2 第二层：标准内存接口
- malloc/free：C 语言的标准内存分配/释放接口
- new/delete：C++ 的动态内存接口，本质上也会调用 malloc 等

## 2.3 第三层：具体的分配器实现
- <mark>ptmalloc</mark>	:默认的 glibc malloc 实现，适用于多数 Linux 程序
- <mark>jemalloc</mark>	:Facebook 等广泛使用，性能更好，碎片更少
- <mark>tcmalloc</mark>	:Google 出品，适用于高性能服务（如 Bigtable）
## 3. 内核空间内存管理层次结构
```sql
sys_brk/sys_mmap/sys_munmap
+-------------------------------------------------------+
| 虚拟内存管理 | 页回收 | .......................        |
+-------------------------------------------------------+
| 页表管理  |  错误异常处理  |  内存碎片整理  |  内存耗尽  |
+------------------------------------------------------------------------------+
|     引导内存分配器  | 块分配器 | 不连续页分配器 | 连续页分配器 | 每处理器内存分配器|
+                    ----------------------------------------------------------+
|                   |                         页分配器                         |
+------------------------------------------------------------------------------+
```
### 3.1 顶层：用户空间系统调用入口
```
sys_brk / sys_mmap / sys_munmap
```
用户空间发起内存管理请求 的接口:
- sys_brk	增加/缩减 heap（通过 brk() 接口）
- sys_mmap	映射一段虚拟内存区域，可能关联文件或匿名页
- sys_munmap	释放一段虚拟内存区域
### 3.2 第二层：虚拟内存管理子系统（VM Subsystem）
虚拟内存管理（VMM）：
- 管理 mm_struct, vm_area_struct
- 实现 mmap, munmap, do_brk 等
- 维护页表结构，创建和销毁虚拟地址映射

页回收（page reclaim）：
- 管理 active_list 和 inactive_list
- 实现 kswapd, direct reclaim, shrinkers

其他模块（在图中省略）：
- 匿名页管理、文件映射页管理、NUMA策略、COW机制等
### 3.3 第三层：低级内存管理（页框级）
- 页表管理:	建立虚拟地址 → 物理页的映射
- 异常处理:	缺页异常（page fault）处理、写时复制（COW）
- 内存碎片整理:	合并伙伴系统中的碎片页
- 内存耗尽:	OOM Killer 策略处理，防止内核崩溃

### 3.4  第四层：各种内核分配器
- 引导内存分配器（bootmem）:	系统启动早期使用，初始化后被 memblock 替代
- 块分配器（slab/slub/slob）:	对象分配器，管理小块内存
- 不连续页分配器（vmalloc）:	虚拟地址连续，物理地址不连续
- 连续页分配器（alloc_pages）:	伙伴系统（buddy system），返回连续物理页
- 每CPU分配器（per-cpu allocator）:	每个 CPU 拥有独立的内存池，避免多核竞争，提高性能
- 页分配器（Page Allocator）: 最底层的内存分配器，提供最基础的接口,比如：<mark>__alloc_pages_nodemask() alloc_pages()  __get_free_pages()</mark>
