## 1. 套接字类型
### 1.1 SOCK_STREAM
TCP,面向连接的可靠流
### 1.2 SOCK_DGRAM
UDP,无连接的数据报
### 1.3 SOCK_RAW
原始 IP,允许访问底层协议头,支持使用与协议无关的传输层格式收发数据
### 1.4 SOCK_RDM
可靠数据报（不常用），保证顺序但无连接（实验）
### 1.5 SOCK_SEQPACKET
有序可靠报文（面向连接），SCTP、UNIX seqpacket
### 1.6 SOCK_DCCP

## 2. 描述套接字API提供一些方法(内核源码)
> net/socket.c
```C
SYSCALL_DEFINE3(socket, int, family, int, type, int, protocol)
{
	return __sys_socket(family, type, protocol);
}

SYSCALL_DEFINE3(bind, int, fd, struct sockaddr __user *, umyaddr, int, addrlen)
{
	return __sys_bind(fd, umyaddr, addrlen);
}

SYSCALL_DEFINE3(accept, int, fd, struct sockaddr __user *, upeer_sockaddr,
		int __user *, upeer_addrlen)
{
	return __sys_accept4(fd, upeer_sockaddr, upeer_addrlen, 0);
}

SYSCALL_DEFINE3(connect, int, fd, struct sockaddr __user *, uservaddr,
		int, addrlen)
{
	return __sys_connect(fd, uservaddr, addrlen);
}

SYSCALL_DEFINE3(getsockname, int, fd, struct sockaddr __user *, usockaddr,
		int __user *, usockaddr_len)
{
	return __sys_getsockname(fd, usockaddr, usockaddr_len);
}

SYSCALL_DEFINE3(getpeername, int, fd, struct sockaddr __user *, usockaddr,
		int __user *, usockaddr_len)
{
	return __sys_getpeername(fd, usockaddr, usockaddr_len);
}

SYSCALL_DEFINE3(sendmsg, int, fd, struct user_msghdr __user *, msg, unsigned int, flags)
{
	return __sys_sendmsg(fd, msg, flags, true);
}

SYSCALL_DEFINE3(recvmsg, int, fd, struct user_msghdr __user *, msg,
		unsigned int, flags)
{
	return __sys_recvmsg(fd, msg, flags, true);
}
```
## 3.内核源码解析
### 3.1 struct socket

```c
struct socket {
	socket_state		state;
	short			type;
	unsigned long		flags;
	struct file		*file;
	struct sock		*sk;
	const struct proto_ops	*ops; /* Might change with IPV6_ADDRFORM or MPTCP. */
	struct socket_wq	wq;
};
```
#### 3.1.1 socket_state  state
枚举 socket_state（定义在 include/uapi/linux/net.h）,表示套接字当前的高层状态（面向用户态的状态），与 TCP 的 tcp_state 不同，这是通用套接字状态
```c
typedef enum {
	SS_FREE = 0,			/* not allocated		*/
	SS_UNCONNECTED,			/* unconnected to any socket	*/
	SS_CONNECTING,			/* in process of connecting	*/
	SS_CONNECTED,			/* connected to socket		*/
	SS_DISCONNECTING		/* in process of disconnecting	*/
} socket_state;
```
#### 3.1.2 short type
套接字类型，对应用户态 socket() 系统调用的第二个参数 type:
```c
enum sock_type {
	SOCK_STREAM	= 1,  //TCP，面向连接的字节流
	SOCK_DGRAM	= 2, //UDP，无连接数据报
	SOCK_RAW	= 3, // 原始 IP 数据包
	SOCK_RDM	= 4,
	SOCK_SEQPACKET	= 5, // 固定大小消息序列
	SOCK_DCCP	= 6,
	SOCK_PACKET	= 10,
};
```

#### 3.1.3 unsigned long  flags
套接字标志位，用于控制行为或标记状态
```c
#define SOCK_NOSPACE		2 // 发送缓冲区已满
#define SOCK_PASSCRED		3 // 接收者需要获取发送者的凭证
#define SOCK_PASSSEC		4 // 传递安全相关信息
```

#### 3.1.4 struct file	*file
指向该 socket 对应的 VFS 文件对象（struct file），当用户在用户态用 socket() 创建套接字时，内核会在 /proc/<pid>/fd/ 下分配一个文件描述符（fd），并关联到一个 struct file。
<mark>struct file->private_data</mark>会指向这个 struct socket.<br>

支持 VFS 层的文件操作（read、write、poll 等）映射到 socket 操作。文件描述符关闭时（close(fd)）会调用 socket 对应的 release 操作，最终释放 struct socket<br>
