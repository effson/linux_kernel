# 1.GDB/Qemu调试程序


# 2.task_struct结构体

## 2.1. 进程的两种特殊形式

### 2.1.1 内核线程
没有用户虚拟地址空间（mm == NULL）的进程，就是内核线程（Kernel Thread），这是 Linux 内核中的一个通用定义
### 2.1.2 用户线程
用户线程共享用户虚拟地址空间

## 2.2 Linux内核提供API函数设置进程状态
> task_struct{<br>
...
<mark>volatile long state;</mark><br>
...<br>
}<br>
```
#define TASK_RUNNING            0 
#define TASK_INTERRUPTIBLE      1
#define TASK_UNINTERRUPTIBLE    2
#define __TASK_STOPPED          4
#define __TASK_TRACED           8
#define EXIT_ZOMBIE             16
#define EXIT_DEAD               32
#define TASK_DEAD               64
#define TASK_WAKEKILL           128
#define TASK_WAKING             256
#define TASK_PARKED             512
#define TASK_NOLOAD             1024
#define TASK_NEW                2048
#define TASK_STATE_MAX          4096
```
```
状态宏定义	        含义	被      描述
TASK_RUNNING	        运行/可运行	正在 CPU 上运行或在就绪队列中等待调度
TASK_INTERRUPTIBLE	可中断睡眠	睡眠状态，可被信号/唤醒事件中断，如 msleep()
TASK_UNINTERRUPTIBLE	不可中断睡眠	睡眠状态，不响应信号，常用于等待 IO
__TASK_STOPPED	        已停止	被      被 SIGSTOP、SIGTSTP 信号暂停
__TASK_TRACED	        被跟踪	被      被调试器（如 GDB）跟踪（traced）状态
EXIT_ZOMBIE	        僵尸进程	被      进程已终止，但其父进程未 wait()
EXIT_DEAD	        已死亡	被      僵尸进程资源即将释放，极短暂状态
```
```
task_struct 是 Linux 内核中最核心、最复杂的数据结构之一，它完整地描述了一个进程（或线程）在内核中的状态和资源信息。理解 task_struct 是理解 Linux 进程管理和调度的关键。
由于其庞大且随内核版本不断演进，这里列出的是其主要组成部分和关键字段（基于较新内核版本，如 5.x+）：

核心组成部分：

进程状态和标识：
state: 进程的当前状态（TASK_RUNNING, TASK_INTERRUPTIBLE, TASK_UNINTERRUPTIBLE, TASK_STOPPED, TASK_TRACED, EXIT_ZOMBIE, EXIT_DEAD 等）。
exit_state: 进程退出时的状态。
pid: 进程 ID（Process ID）。
tgid: 线程组 ID（Thread Group ID）。对于主线程，tgid == pid；对于同一进程的其他线程，tgid 相同（等于主线程的 pid）。
ppid: 父进程的 PID。
real_parent: 指向创建该进程的原始父进程的 task_struct。
parent: 指向当前接收该进程退出信号（SIGCHLD）的父进程（通常是 real_parent，但可能被 ptrace 修改）。
children: 链表头，指向该进程创建的所有直接子进程。
sibling: 链表节点，用于将本进程链接到其父进程的 children 链表中。
group_leader: 指向该进程所属线程组的组长（通常是主线程）。
thread_group: 链表头，指向属于同一线程组（即同一进程）的所有线程。
comm: 可执行文件名（通常截断到 TASK_COMM_LEN 字节，默认为 16 字节）。

调度信息：
prio: 进程的动态优先级（调度器实际使用的优先级）。
static_prio: 进程的静态优先级（由用户或系统设定，nice 值映射而来）。
normal_prio: 基于 static_prio 和调度策略计算出的归一化优先级。
rt_priority: 实时进程的优先级（0-99，值越大优先级越高）。
sched_class: 指向该进程所属的调度器类（如 fair_sched_class - CFS, rt_sched_class - 实时调度器, idle_sched_class - 空闲调度）。
se: sched_entity 结构体，包含与CFS调度器相关的信息（虚拟运行时间 vruntime, 权重 load, 在红黑树中的节点等）。
rt: sched_rt_entity 结构体，包含与实时调度器相关的信息（运行队列、时间片等）。
dl: sched_dl_entity 结构体，包含与Deadline调度器相关的信息（截止时间、运行时间等）。
policy: 进程的调度策略（SCHED_NORMAL, SCHED_FIFO, SCHED_RR, SCHED_BATCH, SCHED_IDLE, SCHED_DEADLINE）。
cpus_allowed / cpus_mask: 位掩码，表示进程允许在哪些 CPU 核心上运行。
nr_cpus_allowed: 允许运行的 CPU 核心数量。
migration_flags: 迁移相关的标志位。
on_rq: 标志位，指示进程是否在运行队列（runqueue）上。

进程地址空间：
mm: 指向进程的内存描述符 (mm_struct)，包含用户空间内存布局（页表、虚拟内存区域 VMA 列表、堆、栈等）的完整信息。内核线程没有用户空间，此字段为 NULL。
active_mm: 指向当前活跃的地址空间描述符 (mm_struct)。对于普通用户进程，active_mm == mm。对于内核线程（mm = NULL），它借用之前运行的用户进程的 mm_struct，避免切换内核页表。

文件系统与文件描述符：
fs: 指向 fs_struct，包含进程的根目录 (root) 和当前工作目录 (pwd) 信息。
files: 指向 files_struct，包含该进程打开的所有文件描述符表 (fdt) 和相关信息（如 next_fd, close_on_exec 位图）。

信号处理：
signal: 指向 signal_struct，包含整个线程组共享的信号处理信息（信号处理函数 sighand, 待处理信号队列 pending, 信号屏蔽字 blocked 等）。
pending: sigpending 结构体，包含仅此线程私有的待处理信号队列。
blocked: 该线程私有的信号屏蔽字。
sighand: 指向 sighand_struct，包含线程组共享的信号处理函数表（action 数组）。
ptrace: 与调试跟踪 (ptrace) 相关的标志和信息。

时间与定时器：
utime, stime: 进程在用户态和内核态消耗的 CPU 时间（时钟滴答数）。
start_time, real_start_time: 进程创建的时间（单调时间，真实时间）。
cputime_expires: 包含不同 CPU 时间类型的到期信息（用于调度）。
timers_active: 定时器状态标志。

各种定时器链表：如 real_timer (ITIMER_REAL), cpu_timers (进程 CPU 时间限制), signal->cputimer (线程组 CPU 时间统计)。

资源限制与统计：
rlim: 进程的资源限制数组（struct rlimit rlim[RLIM_NLIMITS]），如 RLIMIT_CPU, RLIMIT_DATA, RLIMIT_STACK 等。
rusage: struct rusage，包含进程及其子进程的资源使用统计（如 ru_utime, ru_stime, ru_maxrss）。
mm->total_vm, mm->locked_vm, mm->pinned_vm 等：内存使用统计。

进程间通信 (IPC)：
sysvsem: System V 信号量相关信息。
sysvshm: System V 共享内存相关信息。
posix_message_queues: POSIX 消息队列相关信息。
mq_bytes: 当前进程使用的 POSIX 消息队列总字节数限制。

控制组 (cgroups)：
cgroups: 指向 css_set 结构体，描述该任务（进程/线程）所属的控制组子系统状态集合 (cgroup_subsys_state)。这是 cgroups v2 的核心抽象。
cg_list: 链表节点，用于将任务链接到其所属的 css_set 的任务列表中。

命名空间 (Namespaces)：
nsproxy: 指向 nsproxy 结构体。nsproxy 是一个容器，包含指向该进程可见的各种命名空间的指针：
uts_ns: UTS 命名空间（主机名、域名）。
ipc_ns: IPC 命名空间（System V IPC, POSIX 消息队列）。
mnt_ns: 挂载命名空间（文件系统视图）。
pid_ns: PID 命名空间（进程 ID 层次结构）。
net_ns: 网络命名空间（网络设备、协议栈、端口等）。
cgroup_ns: Cgroup 命名空间（控制组视图）。
time_ns: 时间命名空间（系统时钟偏移）。

内核栈与线程上下文：
stack: 指向该线程的内核栈底部的指针。
thread_info: (传统上位于栈底，现在通常内嵌或通过 stack 访问) 包含架构相关的低级线程信息、抢占标志、CPU 编号等。current 宏通常通过 thread_info 或直接操作栈指针来获取当前任务的 task_struct。
thread: 一个 thread_struct 联合体（架构相关），保存进程切换时需要保存和恢复的硬件上下文（寄存器状态：通用寄存器、浮点寄存器、调试寄存器、段寄存器、指令指针 IP、栈指针 SP 等）。这是进行上下文切换时保存/恢复的核心数据。

其他重要字段：
flags: 各种进程标志位 (PF_*)，如 PF_KTHREAD (内核线程), PF_FORKNOEXEC (fork 了但未 exec), PF_SUPERPRIV (拥有超级用户权限), PF_EXITING (正在退出) 等。
exit_code, exit_signal: 进程退出时的返回值 (exit()/_exit()) 和发送给父进程的信号。
set_child_tid, clear_child_tid: 用于用户空间线程库（如 NPTL）同步父子线程状态。
cred: 指向进程的凭证 (cred 结构体)，包含实际/有效/保存的用户 ID (uid, euid, suid) 和组 ID (gid, egid, sgid) 以及能力集 (capabilities)。权限检查的核心依据。
real_cred: 指向授予进程访问权限的凭证（通常与 cred 相同）。
io_context: I/O 调度相关信息。
audit_context: 审计子系统上下文。
seccomp: Seccomp 过滤器状态。
tasks: 链表节点，用于将本 task_struct 链接到内核全局的进程链表 init_task.tasks 上。
perf_event_ctxp: Performance Events (perf) 上下文指针数组。
```
## 2.3 Linux内核目录结构
### arch
```
功能：为不同 CPU 架构（如 x86、ARM、RISC-V、MIPS）提供特定实现。
子目录：x86/、arm/、riscv/ 等。
内容示例：
启动代码（boot）
中断处理（entry.S）
汇编与上下文切换逻辑
平台初始化、设备树支持
```
### block
```
块设备子系统
功能：实现块设备（如硬盘、SSD、NVMe）的通用支持框架。
内容示例：
通用块层 I/O 请求处理（如 I/O 调度器）
请求队列（request_queue）
多队列（blk-mq）处理机制
```
### documentation
```
功能：内核子系统、接口、模块、开发规范说明。
内容示例：
filesystems/ 文件系统接口文档
scheduler/ 调度器原理说明
.rst 格式，结合 Sphinx 生成 HTML 手册
```
### drivers
```
功能：各种硬件设备的驱动支持。
子目录示例：
net/ 网络驱动（如 Intel 网卡）
gpu/ 图形驱动
usb/ USB 控制器和设备
char/ 字符设备驱动
scsi/ SCSI 存储支持
Linux 驱动开发主要围绕这个目录展开。
```
### init
```
功能：内核启动后的初始化逻辑。
内容示例：
main.c：入口 start_kernel() 在这里定义
启动参数解析、子系统初始化、idle 任务创建等
```
### ipc
```
进程间通信
功能：System V IPC 支持，如：
msg.c 消息队列
sem.c 信号量
shm.c 共享内存
```
### kernel
```
核心子系统
功能：与调度器、信号、定时器、fork 等进程管理相关。
内容示例：
sched/ 调度器
time/ 时间管理
fork.c 进程创建
signal.c 信号处理
printk.c 日志系统
```
### lib
```
通用库代码
功能：非平台相关的工具函数，供全内核使用。
内容示例：
crc32.c 校验函数
kobject.c 内核对象模型
字符串、位图、哈希表等工具函数
```
### licenses
```
授权信息
功能：内核或模块的授权信息，支持 SPDX 标识
内容：
GPL-2.0、MIT、BSD 等许可证模板文件
模块可通过 SPDX 注释引入许可证标识
```
### mm
```
内存管理子系统
功能：核心内存管理实现。
内容示例：
虚拟地址到物理地址映射（页表）
页框分配器（buddy system, slab）
匿名页、文件映射、页面回收（swap）
NUMA 支持、HugePage 支持
```
### net
```
网络协议栈
功能：实现 Linux 网络子系统。
子目录：
ipv4/、ipv6/：实现 IP 协议
core/：socket、网络接口等通用核心
sched/：流量控制（TC）
bridge/、xfrm/、wireless/、unix/ 等特殊协议支持
```
### samples
### sound
### tools
### usr
### virt
```
虚拟化支持
功能：与虚拟化相关的框架支持，如：
KVM（Kernel-based Virtual Machine）
Xen、Hyper-V 等虚拟化平台
提供对 guest VM 的调度、IO 中断转发、hypercall 支持等

```
